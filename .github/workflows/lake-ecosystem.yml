name: Lake Ecosystem Quint Spec

on:
  push:
    branches: [main, master]
    paths:
      - 'lake-ecosystem-example/specs/**'
      - '.github/workflows/lake-ecosystem.yml'
  pull_request:
    paths:
      - 'lake-ecosystem-example/specs/**'
      - '.github/workflows/lake-ecosystem.yml'

jobs:
  typecheck:
    name: Typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install -g @informalsystems/quint@0.30.0
      - run: quint typecheck lake-ecosystem-example/specs/lakeEcosystem.qnt

  safety-invariants:
    name: Safety Invariants
    needs: typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install -g @informalsystems/quint@0.30.0
      - name: Check safetyInvariant
        run: |
          quint run lake-ecosystem-example/specs/lakeEcosystem.qnt \
            --main=lakeEcosystemDefault \
            --invariant=safetyInvariant \
            --max-steps=200 \
            --max-samples=10000

  witnesses:
    name: Witness – ${{ matrix.witness }}
    needs: typecheck
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Liveness witnesses
          - witness: canReachAlgaeBloom
            max-steps: 200
          - witness: canReachFishKill
            max-steps: 100
          - witness: canCompleteSeason
            max-steps: 100
          - witness: canRecoverFromStress
            max-steps: 100
          - witness: canReachEutrophication
            max-steps: 200
          # Season witnesses
          - witness: canReachSpring
            max-steps: 100
          - witness: canReachSummer
            max-steps: 100
          - witness: canReachAutumn
            max-steps: 100
          - witness: canReachWinter
            max-steps: 100
          # Health state witnesses
          - witness: canReachHealthy
            max-steps: 100
          - witness: canReachStressed
            max-steps: 100
          - witness: canReachAlgaeBloomHealth
            max-steps: 200
          - witness: canReachOxygenCrisis
            max-steps: 100
          # Ecological event witnesses
          - witness: canReachMinnowSpawn
            max-steps: 100
          - witness: canReachWalleyeSpawn
            max-steps: 100
          - witness: canReachDetritus
            max-steps: 100
          - witness: canReachLowOxygen
            max-steps: 100
          - witness: canReachHighNutrients
            max-steps: 100
          - witness: canReachNutrientDepletion
            max-steps: 100
          - witness: canReachDecomposition
            max-steps: 100
          # Causal chain witnesses
          - witness: canSeeAlgaeKillWalleye
            max-steps: 200
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install -g @informalsystems/quint@0.30.0
      - name: "Witness: ${{ matrix.witness }}"
        run: |
          # Witnesses use negated invariants — a VIOLATION means the scenario IS reachable (good).
          # No violation means the scenario may be unreachable (bad).
          output=$(quint run lake-ecosystem-example/specs/lakeEcosystem_witnesses.qnt \
            --main=lakeEcosystem_witnesses \
            --invariant=${{ matrix.witness }} \
            --max-steps=${{ matrix.max-steps }} \
            --max-samples=10000 2>&1) || true

          echo "$output"

          if echo "$output" | grep -q '\[violation\]'; then
            echo ""
            echo "PASS: Witness '${{ matrix.witness }}' is reachable (violation found)."
          else
            echo ""
            echo "FAIL: Witness '${{ matrix.witness }}' could not be reached."
            echo "The spec may be overly constrained or the step budget too low."
            exit 1
          fi
